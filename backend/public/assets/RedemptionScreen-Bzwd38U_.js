import{w as me,a as oe,u as xe,b as he,r as n,z as pe,j as e,m as U,P as $,T as K,X as Q,C as ue,h as je,q as T,W as H,d as D,e as y,g as E,S as w,s as X,x as fe,k as Ne}from"./index-o28qtZ4E.js";import{a as Y,c as ge,f as c}from"./formatters-BhAPqf4o.js";import{P as be}from"./PageWrapper-D4uzFYGf.js";import{m as o,B as x}from"./proxy-D6mGC7EI.js";import{C as u,I as F,M as ve}from"./Modal-7Sg338uS.js";import{B as ye}from"./Badge-Br48OPWn.js";import{A as J}from"./index-B9GDT2Wk.js";import{S as we}from"./scale-DaJuZKuB.js";import{C as ze}from"./clock-C6f4WYXs.js";import{D as Z}from"./dollar-sign-CXfw5wgV.js";import{S as Ce}from"./shield-check-BgGHvqnq.js";import{C as Pe}from"./credit-card-CogcOOr3.js";import{B as Se}from"./building-2-xsKCLuU5.js";import{P as Ie}from"./printer-BXY7LAxL.js";import{M as Re}from"./message-square-DD02v1BD.js";import{P as ke}from"./plus-CQNf_PUI.js";const Ae=[["rect",{x:"3",y:"8",width:"18",height:"4",rx:"1",key:"bkv52"}],["path",{d:"M12 8v13",key:"1c76mn"}],["path",{d:"M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7",key:"6wjy6b"}],["path",{d:"M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5",key:"1ihvrl"}]],W=me("gift",Ae);function He(){const ee=oe(),r=xe(),{selectedPledge:z}=he(s=>s.pledges),[C,P]=n.useState(""),[se,G]=n.useState(!1),[t,h]=n.useState(null),[I,j]=n.useState(null),[p,te]=n.useState("cash"),[m,V]=n.useState(""),[B,ae]=n.useState(""),[f,R]=n.useState(!1),[N,k]=n.useState(!1),[le,O]=n.useState(!1),[ne,L]=n.useState(!1),[d,ie]=n.useState(null);n.useEffect(()=>{z&&(h(z),P(z.id),r(pe(null)))},[z,r]);const a=(s=>{if(!s)return{principal:0,interest:0,total:0,months:0};const l=new Date(s.createdAt),g=Math.max(1,Math.ceil((new Date-l)/(1e3*60*60*24*30)));let A=0;for(let v=1;v<=g;v++){const M=v<=6?.5:1.5;A+=s.loanAmount*(M/100)}const b=(s.renewals||[]).reduce((v,M)=>v+M.amount,0),i=Math.max(0,A-b);return{principal:s.loanAmount,interest:i,total:s.loanAmount+i,months:g,paidInterest:b}})(t),_=()=>{if(!C.trim()){r(y({type:"warning",title:"Required",message:"Please enter a pledge ID"}));return}G(!0),setTimeout(()=>{const l=E(w.PLEDGES,[]).find(S=>S.id.toLowerCase()===C.toLowerCase().trim());l?l.status==="active"||l.status==="overdue"?(h(l),j("found"),r(y({type:"success",title:"Found",message:`Pledge ${l.id} loaded`}))):(j("invalid"),h(null),r(y({type:"error",title:"Invalid Status",message:`Pledge is already ${l.status}. Cannot process redemption.`}))):(j("not_found"),h(null)),G(!1)},500)},ce=()=>{if(!t)return;if(!f||!N){r(y({type:"error",title:"Verification Required",message:"Please verify IC and items before processing"}));return}const s=parseFloat(m)||0;if(s<a.total){r(y({type:"error",title:"Insufficient",message:`Amount must be at least ${c(a.total)}`}));return}O(!0),setTimeout(()=>{const l=E(w.PLEDGES,[]),S={...t,status:"redeemed",redeemedAt:new Date().toISOString(),redemptionAmount:a.total,redemptionPaymentMethod:p,redemptionReferenceNo:B,amountReceived:s,changeGiven:s-a.total},g=l.map(i=>i.id===t.id?S:i);X(w.PLEDGES,g),r(fe(g));const b=E(w.CUSTOMERS,[]).map(i=>i.id===t.customerId?{...i,activePledges:Math.max(0,(i.activePledges||0)-1),lastVisit:new Date().toISOString().split("T")[0]}:i);X(w.CUSTOMERS,b),r(Ne(b)),ie({pledgeId:t.id,customerName:t.customerName,principal:a.principal,interest:a.interest,totalPaid:a.total,change:s-a.total,items:t.items,paymentMethod:p}),O(!1),L(!0)},1e3)},re=()=>{if(!t)return 0;const s=new Date,l=new Date(t.createdAt);return Math.ceil((s-l)/(1e3*60*60*24))},de={hidden:{opacity:0},visible:{opacity:1,transition:{staggerChildren:.1}}},q={hidden:{opacity:0,y:20},visible:{opacity:1,y:0}};return e.jsxs(be,{title:"Redemption",subtitle:"Process full payment and release items",children:[e.jsxs(o.div,{className:"max-w-4xl mx-auto",variants:de,initial:"hidden",animate:"visible",children:[e.jsx(o.div,{variants:q,children:e.jsxs(u,{className:"p-6 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-emerald-100 flex items-center justify-center",children:e.jsx(U,{className:"w-5 h-5 text-emerald-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-zinc-800",children:"Find Pledge"}),e.jsx("p",{className:"text-sm text-zinc-500",children:"Search by Pledge ID"})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:"flex-1",children:e.jsx(F,{placeholder:"Enter Pledge ID (e.g., PLG-2024-0001)",value:C,onChange:s=>P(s.target.value),onKeyDown:s=>s.key==="Enter"&&_(),leftIcon:$})}),e.jsx(x,{variant:"primary",leftIcon:U,onClick:_,loading:se,children:"Search"})]}),e.jsxs(J,{children:[I==="not_found"&&e.jsx(o.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0},className:"mt-4 p-4 bg-amber-50 border border-amber-200 rounded-xl",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(K,{className:"w-5 h-5 text-amber-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-amber-800",children:"Pledge not found"}),e.jsxs("p",{className:"text-sm text-amber-600",children:['No pledge matches "',C,'"']})]})]})}),I==="invalid"&&e.jsx(o.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0},className:"mt-4 p-4 bg-red-50 border border-red-200 rounded-xl",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Q,{className:"w-5 h-5 text-red-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-red-800",children:"Cannot process redemption"}),e.jsx("p",{className:"text-sm text-red-600",children:"This pledge is not active"})]})]})})]})]})}),e.jsx(J,{children:t&&e.jsxs(o.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},className:"space-y-6",children:[e.jsxs(u,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-14 h-14 rounded-full bg-gradient-to-br from-amber-500 to-amber-600 flex items-center justify-center text-white font-bold text-xl",children:t.customerName?.charAt(0)}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"text-lg font-semibold text-zinc-800",children:t.customerName}),e.jsx(ye,{variant:t.status==="overdue"?"error":"success",children:t.status==="overdue"?"Overdue":"Active"})]}),e.jsxs("p",{className:"text-sm text-zinc-500",children:[e.jsx("span",{className:"font-mono",children:t.id})," • IC: ",Y(t.customerIC)]})]})]}),e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>{h(null),j(null),P(""),R(!1),k(!1)},children:e.jsx(Q,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"p-4 bg-zinc-50 rounded-xl mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx($,{className:"w-5 h-5 text-zinc-400"}),e.jsxs("span",{className:"font-medium text-zinc-700",children:["Pledged Items (",t.items?.length,")"]})]}),e.jsx("div",{className:"space-y-2",children:t.items?.map((s,l)=>e.jsxs("div",{className:"flex items-center justify-between text-sm p-2 bg-white rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(we,{className:"w-4 h-4 text-amber-500"}),e.jsx("span",{className:"capitalize",children:s.category}),e.jsx("span",{className:"text-zinc-400",children:"•"}),e.jsxs("span",{children:[s.purity," Gold"]}),e.jsx("span",{className:"text-zinc-400",children:"•"}),e.jsxs("span",{children:[parseFloat(s.weight).toFixed(2),"g"]})]}),e.jsx("span",{className:"font-mono text-xs text-zinc-400",children:s.barcode})]},l))}),e.jsxs("div",{className:"mt-3 pt-3 border-t border-zinc-200 flex justify-between",children:[e.jsx("span",{className:"text-zinc-500",children:"Total Weight"}),e.jsxs("span",{className:"font-semibold",children:[t.totalWeight?.toFixed(2),"g"]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"p-3 bg-zinc-50 rounded-lg text-center",children:[e.jsx(ue,{className:"w-5 h-5 text-zinc-400 mx-auto mb-1"}),e.jsx("p",{className:"text-xs text-zinc-500",children:"Created"}),e.jsx("p",{className:"text-sm font-medium",children:ge(t.createdAt)})]}),e.jsxs("div",{className:"p-3 bg-zinc-50 rounded-lg text-center",children:[e.jsx(ze,{className:"w-5 h-5 text-zinc-400 mx-auto mb-1"}),e.jsx("p",{className:"text-xs text-zinc-500",children:"Duration"}),e.jsxs("p",{className:"text-sm font-medium",children:[re()," days"]})]}),e.jsxs("div",{className:"p-3 bg-zinc-50 rounded-lg text-center",children:[e.jsx(je,{className:"w-5 h-5 text-zinc-400 mx-auto mb-1"}),e.jsx("p",{className:"text-xs text-zinc-500",children:"Renewals"}),e.jsx("p",{className:"text-sm font-medium",children:t.renewals?.length||0})]})]})]}),e.jsxs(u,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-amber-100 flex items-center justify-center",children:e.jsx(Z,{className:"w-5 h-5 text-amber-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-zinc-800",children:"Payment Summary"}),e.jsx("p",{className:"text-sm text-zinc-500",children:"Total amount to collect"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center p-3 bg-zinc-50 rounded-lg",children:[e.jsx("span",{className:"text-zinc-600",children:"Principal Amount"}),e.jsx("span",{className:"font-semibold",children:c(a.principal)})]}),e.jsxs("div",{className:"flex justify-between items-center p-3 bg-amber-50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-amber-700",children:"Outstanding Interest"}),e.jsxs("p",{className:"text-xs text-amber-600",children:[a.months," month(s)"]})]}),e.jsx("span",{className:"font-semibold text-amber-600",children:c(a.interest)})]}),a.paidInterest>0&&e.jsxs("div",{className:"flex justify-between items-center p-3 bg-blue-50 rounded-lg",children:[e.jsx("span",{className:"text-blue-700",children:"Already Paid (Renewals)"}),e.jsxs("span",{className:"font-semibold text-blue-600",children:["-",c(a.paidInterest)]})]}),e.jsxs("div",{className:"flex justify-between items-center p-4 bg-emerald-50 border-2 border-emerald-200 rounded-xl",children:[e.jsx("span",{className:"font-semibold text-emerald-800",children:"Total Redemption Amount"}),e.jsx("span",{className:"text-2xl font-bold text-emerald-600",children:c(a.total)})]})]})]}),e.jsxs(u,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center",children:e.jsx(Ce,{className:"w-5 h-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-zinc-800",children:"Verification Checklist"}),e.jsx("p",{className:"text-sm text-zinc-500",children:"Confirm before releasing items"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:"flex items-center gap-3 p-4 border border-zinc-200 rounded-xl cursor-pointer hover:border-emerald-300 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:f,onChange:s=>R(s.target.checked),className:"w-5 h-5 rounded border-zinc-300 text-emerald-500 focus:ring-emerald-500"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-zinc-800",children:"IC Verified"}),e.jsxs("p",{className:"text-sm text-zinc-500",children:["Customer IC matches: ",Y(t.customerIC)]})]}),f&&e.jsx(T,{className:"w-5 h-5 text-emerald-500"})]}),e.jsxs("label",{className:"flex items-center gap-3 p-4 border border-zinc-200 rounded-xl cursor-pointer hover:border-emerald-300 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:N,onChange:s=>k(s.target.checked),className:"w-5 h-5 rounded border-zinc-300 text-emerald-500 focus:ring-emerald-500"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-zinc-800",children:"Items Verified"}),e.jsxs("p",{className:"text-sm text-zinc-500",children:["All ",t.items?.length," item(s) checked and ready for release"]})]}),N&&e.jsx(T,{className:"w-5 h-5 text-emerald-500"})]})]})]}),e.jsxs(u,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-emerald-100 flex items-center justify-center",children:e.jsx(H,{className:"w-5 h-5 text-emerald-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-zinc-800",children:"Collect Payment"}),e.jsx("p",{className:"text-sm text-zinc-500",children:"Process redemption payment"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-zinc-700 mb-2",children:"Payment Method"}),e.jsx("div",{className:"grid grid-cols-3 gap-3",children:[{value:"cash",label:"Cash",icon:H},{value:"card",label:"Card",icon:Pe},{value:"transfer",label:"Transfer",icon:Se}].map(s=>e.jsxs("button",{onClick:()=>te(s.value),className:D("p-3 rounded-xl border-2 transition-all flex flex-col items-center gap-2",p===s.value?"border-emerald-500 bg-emerald-50":"border-zinc-200 hover:border-zinc-300"),children:[e.jsx(s.icon,{className:D("w-5 h-5",p===s.value?"text-emerald-600":"text-zinc-400")}),e.jsx("span",{className:D("text-sm font-medium",p===s.value?"text-emerald-600":"text-zinc-600"),children:s.label})]},s.value))})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(F,{label:"Amount Received (RM)",type:"number",step:"0.01",placeholder:a.total.toFixed(2),value:m,onChange:s=>V(s.target.value),leftIcon:Z}),p!=="cash"&&e.jsx(F,{label:"Reference No.",placeholder:"Transaction reference",value:B,onChange:s=>ae(s.target.value)})]}),m&&parseFloat(m)>a.total&&e.jsx("div",{className:"p-3 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-blue-700",children:"Change to Return"}),e.jsx("span",{className:"text-lg font-bold text-blue-600",children:c(parseFloat(m)-a.total)})]})}),e.jsx(x,{variant:"success",size:"lg",fullWidth:!0,leftIcon:W,onClick:ce,loading:le,disabled:!f||!N||!m||parseFloat(m)<a.total,children:"Complete Redemption - Release Items"}),(!f||!N)&&e.jsxs("p",{className:"text-center text-sm text-amber-600",children:[e.jsx(K,{className:"w-4 h-4 inline mr-1"}),"Please complete verification checklist first"]})]})]})]})}),!t&&!I&&e.jsx(o.div,{variants:q,children:e.jsxs(u,{className:"p-12 text-center",children:[e.jsx(W,{className:"w-16 h-16 text-zinc-300 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-zinc-800 mb-2",children:"Process Redemption"}),e.jsx("p",{className:"text-zinc-500 mb-4",children:"Search for a pledge to process full payment and release items"})]})})]}),e.jsx(ve,{isOpen:ne,onClose:()=>{},title:"Redemption Complete!",size:"md",children:e.jsxs("div",{className:"p-6 text-center",children:[e.jsx(o.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:200},className:"w-20 h-20 rounded-full bg-emerald-100 flex items-center justify-center mx-auto mb-4",children:e.jsx(W,{className:"w-10 h-10 text-emerald-600"})}),e.jsx("h3",{className:"text-xl font-bold text-zinc-800 mb-2",children:"Items Released!"}),e.jsxs("p",{className:"text-zinc-500 mb-4",children:["Pledge ",e.jsx("span",{className:"font-mono font-bold",children:d?.pledgeId})," has been redeemed"]}),e.jsxs("div",{className:"p-4 bg-zinc-50 rounded-xl mb-6 text-left",children:[e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-zinc-500",children:"Customer"}),e.jsx("span",{className:"font-medium",children:d?.customerName})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-zinc-500",children:"Principal"}),e.jsx("span",{className:"font-medium",children:c(d?.principal)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-zinc-500",children:"Interest"}),e.jsx("span",{className:"font-medium",children:c(d?.interest)})]}),e.jsxs("div",{className:"flex justify-between pt-2 border-t border-zinc-200",children:[e.jsx("span",{className:"text-zinc-500",children:"Total Paid"}),e.jsx("span",{className:"font-bold text-emerald-600",children:c(d?.totalPaid)})]}),d?.change>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-zinc-500",children:"Change Given"}),e.jsx("span",{className:"font-medium text-blue-600",children:c(d?.change)})]})]}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-zinc-200",children:[e.jsx("p",{className:"text-sm font-medium text-zinc-700 mb-2",children:"Items Released:"}),e.jsx("div",{className:"space-y-1",children:d?.items?.map((s,l)=>e.jsxs("div",{className:"flex items-center gap-2 text-sm text-zinc-600",children:[e.jsx(T,{className:"w-4 h-4 text-emerald-500"}),e.jsx("span",{className:"capitalize",children:s.category}),e.jsx("span",{className:"text-zinc-400",children:"•"}),e.jsx("span",{children:s.purity}),e.jsx("span",{className:"text-zinc-400",children:"•"}),e.jsxs("span",{children:[parseFloat(s.weight).toFixed(2),"g"]})]},l))})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(x,{variant:"outline",fullWidth:!0,leftIcon:Ie,children:"Print Receipt"}),e.jsx(x,{variant:"outline",fullWidth:!0,leftIcon:Re,children:"Send WhatsApp"})]}),e.jsxs("div",{className:"flex gap-3 mt-4",children:[e.jsx(x,{variant:"primary",fullWidth:!0,onClick:()=>ee("/pledges"),children:"Back to Pledges"}),e.jsx(x,{variant:"accent",fullWidth:!0,leftIcon:ke,onClick:()=>{L(!1),h(null),P(""),j(null),V(""),R(!1),k(!1)},children:"New Redemption"})]})]})})]})}export{He as default};
