import{a as me,u as xe,b as ue,r as l,z as he,j as e,m as Y,P as pe,T as H,X as J,q as W,d as j,h as je,W as Z,C as fe,R as ge,e as z,g as $,S as P,s as ee,x as Ne,k as be}from"./index-o28qtZ4E.js";import{f as x,c as T}from"./formatters-BhAPqf4o.js";import{P as ve}from"./PageWrapper-D4uzFYGf.js";import{m as f,B as g}from"./proxy-D6mGC7EI.js";import{C as I,I as G,M as we}from"./Modal-7Sg338uS.js";import{B as ye}from"./Badge-Br48OPWn.js";import{A as se}from"./index-B9GDT2Wk.js";import{C as De}from"./credit-card-CogcOOr3.js";import{B as Se}from"./building-2-xsKCLuU5.js";import{D as ze}from"./dollar-sign-CXfw5wgV.js";import{P as Pe}from"./printer-BXY7LAxL.js";import{M as Ie}from"./message-square-DD02v1BD.js";import{P as Ce}from"./plus-CQNf_PUI.js";function _e(){const te=me(),c=xe(),{selectedPledge:C}=ue(s=>s.pledges),[R,M]=l.useState(""),[ae,L]=l.useState(!1),[t,N]=l.useState(null),[k,y]=l.useState(null),[D,ne]=l.useState("cash"),[u,U]=l.useState(""),[V,le]=l.useState(""),[h,q]=l.useState(1),[ie,O]=l.useState(!1),[re,_]=l.useState(!1),[i,ce]=l.useState(null);l.useEffect(()=>{C&&(N(C),M(C.id),c(he(null)))},[C,c]);const A=((s,a=null)=>{if(!s?.createdAt||!s?.loanAmount)return{months:0,rate:0,amount:0,total:0,monthlyBreakdown:[]};const o=new Date(s.createdAt);if(isNaN(o.getTime()))return{months:0,rate:0,amount:0,total:s.loanAmount||0,monthlyBreakdown:[]};const r=Math.max(1,Math.ceil((new Date-o)/(1e3*60*60*24*30))),v=a||r;let p=0;const F=[];for(let w=1;w<=v;w++){const E=w<=6?.5:1.5,X=s.loanAmount*(E/100);p+=X,F.push({month:w,rate:E,amount:X})}const S=(s.renewals||[]).reduce((w,E)=>w+E.amount,0),m=Math.max(0,p-S);return{months:v,rate:v<=6?.5:1.5,amount:m,total:s.loanAmount+m,monthlyBreakdown:F,paidInterest:S}})(t),B=(()=>{if(!t)return 0;const s=new Date(t.createdAt),o=Math.ceil((new Date-s)/(1e3*60*60*24*30));let b=0;for(let r=1;r<=h;r++){const p=o+r<=6?.5:1.5;b+=t.loanAmount*(p/100)}return b})(),n=A.amount+B,K=()=>{if(!R.trim()){c(z({type:"warning",title:"Required",message:"Please enter a pledge ID"}));return}L(!0),setTimeout(()=>{const a=$(P.PLEDGES,[]).find(o=>o.id.toLowerCase()===R.toLowerCase().trim());a?a.status==="active"||a.status==="overdue"?(N(a),y("found"),c(z({type:"success",title:"Found",message:`Pledge ${a.id} loaded`}))):(y("invalid"),N(null),c(z({type:"error",title:"Invalid Status",message:`Pledge is ${a.status}. Cannot process renewal.`}))):(y("not_found"),N(null)),L(!1)},500)},de=()=>{if(!t)return;const s=parseFloat(u)||0;if(s<n){c(z({type:"error",title:"Insufficient",message:`Amount must be at least ${x(n)}`}));return}O(!0),setTimeout(()=>{const a=$(P.PLEDGES,[]),o={id:`REN-${Date.now()}`,date:new Date().toISOString(),amount:n,amountReceived:s,change:s-n,extensionMonths:h,paymentMethod:D,referenceNo:V,outstandingInterest:A.amount,extensionInterest:B},b=new Date(t.dueDate);if(isNaN(b.getTime())){c(z({type:"error",title:"Invalid Date",message:"Pledge has invalid due date"})),O(!1);return}const r=new Date(b);r.setMonth(r.getMonth()+h);const v={...t,status:"active",dueDate:r.toISOString(),renewals:[...t.renewals||[],o],lastRenewalDate:new Date().toISOString()},p=a.map(m=>m.id===t.id?v:m);ee(P.PLEDGES,p),c(Ne(p));const S=$(P.CUSTOMERS,[]).map(m=>m.id===t.customerId?{...m,lastVisit:new Date().toISOString().split("T")[0]}:m);ee(P.CUSTOMERS,S),c(be(S)),ce({renewalId:o.id,pledgeId:t.id,customerName:t.customerName,amountPaid:n,change:s-n,newDueDate:r,extensionMonths:h}),O(!1),_(!0)},1e3)},d=(()=>{if(!t?.dueDate)return 0;const s=new Date,a=new Date(t.dueDate);return isNaN(a.getTime())?0:Math.ceil((a-s)/(1e3*60*60*24))})(),oe={hidden:{opacity:0},visible:{opacity:1,transition:{staggerChildren:.1}}},Q={hidden:{opacity:0,y:20},visible:{opacity:1,y:0}};return e.jsxs(ve,{title:"Renewal",subtitle:"Process interest payment and extend pledge period",children:[e.jsxs(f.div,{className:"max-w-4xl mx-auto",variants:oe,initial:"hidden",animate:"visible",children:[e.jsx(f.div,{variants:Q,children:e.jsxs(I,{className:"p-6 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center",children:e.jsx(Y,{className:"w-5 h-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-zinc-800",children:"Find Pledge"}),e.jsx("p",{className:"text-sm text-zinc-500",children:"Search by Pledge ID"})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:"flex-1",children:e.jsx(G,{placeholder:"Enter Pledge ID (e.g., PLG-2024-0001)",value:R,onChange:s=>M(s.target.value),onKeyDown:s=>s.key==="Enter"&&K(),leftIcon:pe})}),e.jsx(g,{variant:"primary",leftIcon:Y,onClick:K,loading:ae,children:"Search"})]}),e.jsxs(se,{children:[k==="not_found"&&e.jsx(f.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0},className:"mt-4 p-4 bg-amber-50 border border-amber-200 rounded-xl",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(H,{className:"w-5 h-5 text-amber-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-amber-800",children:"Pledge not found"}),e.jsxs("p",{className:"text-sm text-amber-600",children:['No pledge matches "',R,'"']})]})]})}),k==="invalid"&&e.jsx(f.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0},className:"mt-4 p-4 bg-red-50 border border-red-200 rounded-xl",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(J,{className:"w-5 h-5 text-red-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-red-800",children:"Cannot process renewal"}),e.jsx("p",{className:"text-sm text-red-600",children:"This pledge is not active"})]})]})})]})]})}),e.jsx(se,{children:t&&e.jsxs(f.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},className:"space-y-6",children:[e.jsxs(I,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-14 h-14 rounded-full bg-gradient-to-br from-amber-500 to-amber-600 flex items-center justify-center text-white font-bold text-xl",children:t.customerName?.charAt(0)}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"text-lg font-semibold text-zinc-800",children:t.customerName}),e.jsx(ye,{variant:t.status==="overdue"?"error":"success",children:t.status==="overdue"?e.jsxs(e.Fragment,{children:[e.jsx(H,{className:"w-3 h-3 mr-1"}),"Overdue"]}):e.jsxs(e.Fragment,{children:[e.jsx(W,{className:"w-3 h-3 mr-1"}),"Active"]})})]}),e.jsx("p",{className:"text-sm text-zinc-500 font-mono",children:t.id})]})]}),e.jsx(g,{variant:"ghost",size:"sm",onClick:()=>{N(null),y(null),M("")},children:e.jsx(J,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"p-3 bg-zinc-50 rounded-lg",children:[e.jsx("p",{className:"text-xs text-zinc-500",children:"Principal"}),e.jsx("p",{className:"text-lg font-semibold text-zinc-800",children:x(t.loanAmount)})]}),e.jsxs("div",{className:"p-3 bg-zinc-50 rounded-lg",children:[e.jsx("p",{className:"text-xs text-zinc-500",children:"Items"}),e.jsxs("p",{className:"text-lg font-semibold text-zinc-800",children:[t.items?.length," (",t.totalWeight?.toFixed(2),"g)"]})]}),e.jsxs("div",{className:"p-3 bg-zinc-50 rounded-lg",children:[e.jsx("p",{className:"text-xs text-zinc-500",children:"Created"}),e.jsx("p",{className:"text-lg font-semibold text-zinc-800",children:T(t.createdAt)})]}),e.jsxs("div",{className:j("p-3 rounded-lg",d<=0?"bg-red-50":d<=7?"bg-amber-50":"bg-zinc-50"),children:[e.jsx("p",{className:"text-xs text-zinc-500",children:"Due Date"}),e.jsx("p",{className:j("text-lg font-semibold",d<=0?"text-red-600":d<=7?"text-amber-600":"text-zinc-800"),children:T(t.dueDate)}),e.jsx("p",{className:j("text-xs",d<=0?"text-red-500":d<=7?"text-amber-500":"text-zinc-400"),children:d>0?`${d} days left`:`${Math.abs(d)} days overdue`})]})]})]}),e.jsxs(I,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-amber-100 flex items-center justify-center",children:e.jsx(je,{className:"w-5 h-5 text-amber-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-zinc-800",children:"Interest Calculation"}),e.jsx("p",{className:"text-sm text-zinc-500",children:"Outstanding interest and extension"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"p-4 bg-red-50 border border-red-200 rounded-xl",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-red-800",children:"Outstanding Interest"}),e.jsxs("p",{className:"text-sm text-red-600",children:[A.months," month(s) @ varying rates"]})]}),e.jsx("p",{className:"text-xl font-bold text-red-600",children:x(A.amount)})]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-zinc-700 mb-2",children:"Extend Period By"}),e.jsx("div",{className:"flex gap-2",children:[1,2,3,6].map(s=>e.jsxs("button",{onClick:()=>q(s),className:j("px-4 py-2 rounded-lg font-medium transition-all",h===s?"bg-amber-500 text-white":"bg-zinc-100 text-zinc-600 hover:bg-zinc-200"),children:[s," ",s===1?"Month":"Months"]},s))})]}),e.jsx("div",{className:"p-4 bg-blue-50 border border-blue-200 rounded-xl",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-blue-800",children:"Extension Interest"}),e.jsxs("p",{className:"text-sm text-blue-600",children:[h," month(s) advance"]})]}),e.jsx("p",{className:"text-xl font-bold text-blue-600",children:x(B)})]})}),e.jsx("div",{className:"p-4 bg-emerald-50 border border-emerald-200 rounded-xl",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-emerald-800",children:"Total Payable"}),e.jsx("p",{className:"text-sm text-emerald-600",children:"Outstanding + Extension"})]}),e.jsx("p",{className:"text-2xl font-bold text-emerald-600",children:x(n)})]})})]})]}),e.jsxs(I,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-emerald-100 flex items-center justify-center",children:e.jsx(Z,{className:"w-5 h-5 text-emerald-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-zinc-800",children:"Payment"}),e.jsx("p",{className:"text-sm text-zinc-500",children:"Collect interest payment"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-zinc-700 mb-2",children:"Payment Method"}),e.jsx("div",{className:"grid grid-cols-3 gap-3",children:[{value:"cash",label:"Cash",icon:Z},{value:"card",label:"Card",icon:De},{value:"transfer",label:"Transfer",icon:Se}].map(s=>e.jsxs("button",{onClick:()=>ne(s.value),className:j("p-3 rounded-xl border-2 transition-all flex flex-col items-center gap-2",D===s.value?"border-amber-500 bg-amber-50":"border-zinc-200 hover:border-zinc-300"),children:[e.jsx(s.icon,{className:j("w-5 h-5",D===s.value?"text-amber-600":"text-zinc-400")}),e.jsx("span",{className:j("text-sm font-medium",D===s.value?"text-amber-600":"text-zinc-600"),children:s.label})]},s.value))})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(G,{label:"Amount Received (RM)",type:"number",step:"0.01",placeholder:n.toFixed(2),value:u,onChange:s=>U(s.target.value),leftIcon:ze}),D!=="cash"&&e.jsx(G,{label:"Reference No.",placeholder:"Transaction reference",value:V,onChange:s=>le(s.target.value)})]}),u&&parseFloat(u)>n&&e.jsx("div",{className:"p-3 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-blue-700",children:"Change"}),e.jsx("span",{className:"text-lg font-bold text-blue-600",children:x(parseFloat(u)-n)})]})}),e.jsx("div",{className:"p-4 bg-zinc-50 rounded-xl",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(fe,{className:"w-5 h-5 text-zinc-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-zinc-500",children:"New Due Date (after renewal)"}),e.jsx("p",{className:"font-semibold text-zinc-800",children:(()=>{if(!t?.dueDate)return"N/A";const s=new Date(t.dueDate);return isNaN(s.getTime())?"Invalid Date":(s.setMonth(s.getMonth()+h),T(s.toISOString()))})()})]})]})}),e.jsxs(g,{variant:"success",size:"lg",fullWidth:!0,leftIcon:W,onClick:de,loading:ie,disabled:!u||parseFloat(u)<n,children:["Process Renewal - ",x(n)]})]})]})]})}),!t&&!k&&e.jsx(f.div,{variants:Q,children:e.jsxs(I,{className:"p-12 text-center",children:[e.jsx(ge,{className:"w-16 h-16 text-zinc-300 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-zinc-800 mb-2",children:"Process Renewal"}),e.jsx("p",{className:"text-zinc-500 mb-4",children:"Search for a pledge to process interest payment and extend the period"})]})})]}),e.jsx(we,{isOpen:re,onClose:()=>{},title:"Renewal Successful!",size:"md",children:e.jsxs("div",{className:"p-6 text-center",children:[e.jsx(f.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:200},className:"w-20 h-20 rounded-full bg-emerald-100 flex items-center justify-center mx-auto mb-4",children:e.jsx(W,{className:"w-10 h-10 text-emerald-600"})}),e.jsx("h3",{className:"text-xl font-bold text-zinc-800 mb-2",children:"Renewal Processed!"}),e.jsxs("p",{className:"text-zinc-500 mb-4",children:["ID: ",e.jsx("span",{className:"font-mono font-bold",children:i?.renewalId})]}),e.jsx("div",{className:"p-4 bg-zinc-50 rounded-xl mb-6 text-left",children:e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-zinc-500",children:"Pledge"}),e.jsx("span",{className:"font-medium",children:i?.pledgeId})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-zinc-500",children:"Customer"}),e.jsx("span",{className:"font-medium",children:i?.customerName})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-zinc-500",children:"Amount Paid"}),e.jsx("span",{className:"font-medium text-emerald-600",children:x(i?.amountPaid)})]}),i?.change>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-zinc-500",children:"Change Given"}),e.jsx("span",{className:"font-medium text-blue-600",children:x(i?.change)})]}),e.jsxs("div",{className:"flex justify-between pt-2 border-t border-zinc-200",children:[e.jsx("span",{className:"text-zinc-500",children:"New Due Date"}),e.jsx("span",{className:"font-bold text-zinc-800",children:i?.newDueDate?T(i.newDueDate instanceof Date?i.newDueDate.toISOString():i.newDueDate):"N/A"})]})]})}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(g,{variant:"outline",fullWidth:!0,leftIcon:Pe,children:"Print Receipt"}),e.jsx(g,{variant:"outline",fullWidth:!0,leftIcon:Ie,children:"Send WhatsApp"})]}),e.jsxs("div",{className:"flex gap-3 mt-4",children:[e.jsx(g,{variant:"primary",fullWidth:!0,onClick:()=>te(`/pledges/${i?.pledgeId}`),children:"View Pledge"}),e.jsx(g,{variant:"accent",fullWidth:!0,leftIcon:Ce,onClick:()=>{_(!1),N(null),M(""),y(null),U(""),q(1)},children:"New Renewal"})]})]})})]})}export{_e as default};
