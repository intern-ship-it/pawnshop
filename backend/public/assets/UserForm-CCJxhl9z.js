import{w as Z,a as xe,u as pe,p as fe,b as ge,r as c,j as e,L as E,U as H,d as u,X as be,M as R,e as z,J as ve,K as je}from"./index-o28qtZ4E.js";import{r as T}from"./roleService-_PZHj77A.js";import{P as ye}from"./PageWrapper-D4uzFYGf.js";import{B as N,E as Ne,a as we,m as _e}from"./proxy-D6mGC7EI.js";import{C as w,I as b,S as ze}from"./Modal-7Sg338uS.js";import"./Badge-Br48OPWn.js";import{M as Se}from"./mail-DO_TKUji.js";import{P as Pe}from"./phone-B5sqxf62.js";import{K as U}from"./key-Cqdn2BOI.js";import{C as J}from"./check-DGHPnJ4E.js";import{S as V}from"./shield-check-BgGHvqnq.js";import{S as Ce}from"./save-CPbhu9KD.js";import{A as ke}from"./arrow-left-Bj3muJoB.js";const Ee=[["line",{x1:"4",x2:"20",y1:"9",y2:"9",key:"4lhtct"}],["line",{x1:"4",x2:"20",y1:"15",y2:"15",key:"vyu0kd"}],["line",{x1:"10",x2:"8",y1:"3",y2:"21",key:"1ggp8o"}],["line",{x1:"16",x2:"14",y1:"3",y2:"21",key:"weycgp"}]],Re=Z("hash",Ee);const Ue=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}]],Ae=Z("shield",Ue),X=()=>{const h=Date.now().toString().slice(-6),x=Math.floor(Math.random()*100).toString().padStart(2,"0");return`EMP${h}${x}`};function Ve(){const p=xe(),h=pe(),{id:x}=fe(),o=!!x,{role:A,branch:F}=ge(s=>s.auth),$=(A?.slug||A||"")==="super-admin",[a,v]=c.useState({employee_id:"",username:"",password:"",confirmPassword:"",name:"",email:"",phone:"",role_id:"",branch_id:"",is_active:!0}),[d,S]=c.useState({}),[_,Q]=c.useState(!1),[Y,D]=c.useState(!1),[ee,I]=c.useState(!0),[L,se]=c.useState([]),[ae,te]=c.useState([]),[B,re]=c.useState({}),[P,M]=c.useState([]),[f,j]=c.useState([]),[g,y]=c.useState([]),[O,q]=c.useState(!1),[C,ie]=c.useState(!1);c.useEffect(()=>{(async()=>{I(!0);try{const t=await T.getRoles();t.success&&se(t.data||[]);const r=await R("/branches");r.success&&te(r.data||[]);const n=await R("/permissions");if(n.success&&re(n.data||{}),o&&x){const i=await R(`/users/${x}`);if(i.success&&i.data){const l=i.data.user||i.data;v({employee_id:l.employee_id||"",username:l.username||"",password:"",confirmPassword:"",name:l.name||"",email:l.email||"",phone:l.phone||"",role_id:l.role_id?.toString()||l.role?.id?.toString()||"",branch_id:l.branch_id?.toString()||l.branch?.id?.toString()||"",is_active:l.is_active!==!1}),i.data.custom_permissions&&(j(i.data.custom_permissions.granted||[]),y(i.data.custom_permissions.revoked||[])),(l.role_id||l.role?.id)&&G(l.role_id||l.role?.id)}else h(z({type:"error",title:"Not Found",message:"User not found"})),p("/settings/users")}else v(i=>({...i,employee_id:X(),branch_id:F?.id?.toString()||""}))}catch(t){console.error("Error fetching data:",t),h(z({type:"error",title:"Error",message:"Failed to load form data"}))}finally{I(!1)}})()},[x,o,p,h,F]);const G=async s=>{if(!s){M([]);return}q(!0);try{const t=await T.getRolePermissions(s);if(t.success&&t.data){const r=[];Object.values(t.data).forEach(n=>{Array.isArray(n)&&n.forEach(i=>{i.is_enabled&&r.push(i.id)})}),M(r)}}catch(t){console.error("Error fetching role permissions:",t)}finally{q(!1)}},ne=s=>{v(t=>({...t,role_id:s})),j([]),y([]),G(s)},m=(s,t)=>{v(r=>({...r,[s]:t})),d[s]&&S(r=>({...r,[s]:null}))},le=(s,t)=>{P.includes(s)?(y(t?n=>n.filter(i=>i!==s):n=>[...n.filter(i=>i!==s),s]),j(n=>n.filter(i=>i!==s))):(j(t?n=>[...n.filter(i=>i!==s),s]:n=>n.filter(i=>i!==s)),y(n=>n.filter(i=>i!==s)))},K=s=>{const t=P.includes(s),r=f.includes(s),n=g.includes(s);return(t||r)&&!n},oe=s=>{const t=P.includes(s),r=f.includes(s);return g.includes(s)?{label:"Revoked",color:"text-red-500"}:r?{label:"Custom",color:"text-blue-500"}:t?{label:"From Role",color:"text-zinc-400"}:{label:"",color:""}},ce=()=>{const s={};return a.employee_id.trim()||(s.employee_id="Employee ID is required"),a.name.trim()||(s.name="Full name is required"),a.username.trim()?a.username.length<3?s.username="Username must be at least 3 characters":/^[a-zA-Z0-9_]+$/.test(a.username)||(s.username="Username can only contain letters, numbers and underscore"):s.username="Username is required",a.email.trim()?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a.email)||(s.email="Invalid email format"):s.email="Email is required",!o&&!a.password?s.password="Password is required":a.password&&a.password.length<8&&(s.password="Password must be at least 8 characters"),a.password&&a.password!==a.confirmPassword&&(s.confirmPassword="Passwords do not match"),a.role_id||(s.role_id="Role is required"),S(s),Object.keys(s).length===0},de=async s=>{if(s.preventDefault(),!!ce()){D(!0);try{const t={employee_id:a.employee_id,username:a.username,name:a.name,email:a.email,phone:a.phone||null,role_id:parseInt(a.role_id),is_active:a.is_active,custom_permissions:{granted:f,revoked:g}};a.branch_id&&(t.branch_id=parseInt(a.branch_id)),a.password&&(t.password=a.password);let r;if(o?r=await ve(`/users/${x}`,t):r=await je("/users",t),r.success)h(z({type:"success",title:o?"User Updated":"User Created",message:`${a.name} has been ${o?"updated":"added"}`})),p("/settings/users");else{if(r.errors){const n={};Object.entries(r.errors).forEach(([i,l])=>{n[i]=l[0]}),S(n)}throw new Error(r.message||"Failed to save user")}}catch(t){h(z({type:"error",title:"Error",message:t.message||"Failed to save user"}))}finally{D(!1)}}},me=()=>{v(s=>({...s,employee_id:X()}))},ue=L.map(s=>({value:s.id?.toString(),label:s.name,description:s.description||`${s.name} role`,slug:s.slug})),he=ae.map(s=>({value:s.id?.toString(),label:`${s.code} - ${s.name}`})),k=(()=>{const s=[];return Object.entries(B).forEach(([t,r])=>{Array.isArray(r)&&r.forEach(n=>{K(n.id)&&s.push(n.name)})}),s})(),W=L.find(s=>s.id?.toString()===a.role_id);return ee?e.jsx("div",{className:"min-h-[60vh] flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(E,{className:"w-12 h-12 text-amber-500 animate-spin mx-auto mb-4"}),e.jsx("p",{className:"text-zinc-500",children:"Loading..."})]})}):e.jsx(ye,{title:o?"Edit User":"Create User",subtitle:o?"Update user information and permissions":"Add a new system user",actions:e.jsx(N,{variant:"outline",leftIcon:ke,onClick:()=>p("/settings/users"),children:"Back to Users"}),children:e.jsx("form",{onSubmit:de,children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(w,{className:"p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-zinc-800 mb-6 flex items-center gap-2",children:[e.jsx(H,{className:"w-5 h-5 text-amber-500"}),"Basic Information"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-zinc-700 mb-1.5",children:"Employee ID *"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(Re,{className:"h-4 w-4 text-zinc-400"})}),e.jsx("input",{type:"text",value:a.employee_id,onChange:s=>m("employee_id",s.target.value.toUpperCase()),disabled:o,className:u("block w-full pl-9 pr-3 py-2 border rounded-lg text-sm","bg-white text-zinc-900 placeholder-zinc-400","focus:outline-none focus:ring-2 focus:ring-amber-500/20 focus:border-amber-500",d.employee_id?"border-red-300":"border-zinc-300",o&&"bg-zinc-50 cursor-not-allowed"),placeholder:"EMP001"})]}),!o&&e.jsx(N,{type:"button",variant:"outline",size:"sm",onClick:me,children:"Generate"})]}),d.employee_id&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.employee_id})]}),e.jsx(b,{label:"Username *",value:a.username,onChange:s=>m("username",s.target.value.toLowerCase()),placeholder:"Enter username",error:d.username,disabled:o}),e.jsx(b,{label:"Full Name *",value:a.name,onChange:s=>m("name",s.target.value),placeholder:"Enter full name",error:d.name,leftIcon:H}),e.jsx(b,{label:"Email *",type:"email",value:a.email,onChange:s=>m("email",s.target.value),placeholder:"Enter email address",error:d.email,leftIcon:Se}),e.jsx(b,{label:"Phone",value:a.phone,onChange:s=>m("phone",s.target.value),placeholder:"012-345 6789",error:d.phone,leftIcon:Pe})]})]}),e.jsxs(w,{className:"p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-zinc-800 mb-6 flex items-center gap-2",children:[e.jsx(U,{className:"w-5 h-5 text-amber-500"}),o?"Change Password":"Set Password"]}),o&&e.jsx("p",{className:"text-sm text-zinc-500 mb-4",children:"Leave blank to keep current password"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"relative",children:[e.jsx(b,{label:o?"New Password":"Password *",type:_?"text":"password",value:a.password,onChange:s=>m("password",s.target.value),placeholder:"Minimum 8 characters",error:d.password,leftIcon:U}),e.jsx("button",{type:"button",onClick:()=>Q(!_),className:"absolute right-3 top-9 text-zinc-400 hover:text-zinc-600",children:_?e.jsx(Ne,{className:"w-4 h-4"}):e.jsx(we,{className:"w-4 h-4"})})]}),e.jsx(b,{label:"Confirm Password",type:_?"text":"password",value:a.confirmPassword,onChange:s=>m("confirmPassword",s.target.value),placeholder:"Confirm password",error:d.confirmPassword,leftIcon:U})]})]}),e.jsxs(w,{className:"p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-zinc-800 mb-6 flex items-center gap-2",children:[e.jsx(Ae,{className:"w-5 h-5 text-amber-500"}),"Role & Assignment"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-zinc-700 mb-2",children:"Role *"}),e.jsx("div",{className:"space-y-2",children:ue.map(s=>e.jsxs("label",{className:u("flex items-center gap-3 p-3 rounded-lg border-2 cursor-pointer transition-all",a.role_id===s.value?"border-amber-500 bg-amber-50":"border-zinc-200 hover:border-zinc-300"),children:[e.jsx("input",{type:"radio",name:"role",value:s.value,checked:a.role_id===s.value,onChange:t=>ne(t.target.value),className:"sr-only"}),e.jsx("div",{className:u("w-4 h-4 rounded-full border-2 flex items-center justify-center",a.role_id===s.value?"border-amber-500":"border-zinc-300"),children:a.role_id===s.value&&e.jsx("div",{className:"w-2 h-2 rounded-full bg-amber-500"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-zinc-800",children:s.label}),e.jsx("p",{className:"text-xs text-zinc-500",children:s.description})]})]},s.value))}),d.role_id&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:d.role_id})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(ze,{label:"Branch",value:a.branch_id,onChange:s=>m("branch_id",s.target.value),options:[{value:"",label:"Select branch"},...he],error:d.branch_id,disabled:!$}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-zinc-700 mb-2",children:"Status"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("label",{className:u("flex-1 flex items-center justify-center gap-2 p-3 rounded-lg border-2 cursor-pointer transition-all",a.is_active?"border-emerald-500 bg-emerald-50":"border-zinc-200 hover:border-zinc-300"),children:[e.jsx("input",{type:"radio",name:"status",checked:a.is_active,onChange:()=>m("is_active",!0),className:"sr-only"}),e.jsx(J,{className:u("w-4 h-4",a.is_active?"text-emerald-500":"text-zinc-400")}),e.jsx("span",{className:a.is_active?"text-emerald-700 font-medium":"text-zinc-600",children:"Active"})]}),e.jsxs("label",{className:u("flex-1 flex items-center justify-center gap-2 p-3 rounded-lg border-2 cursor-pointer transition-all",a.is_active?"border-zinc-200 hover:border-zinc-300":"border-zinc-500 bg-zinc-50"),children:[e.jsx("input",{type:"radio",name:"status",checked:!a.is_active,onChange:()=>m("is_active",!1),className:"sr-only"}),e.jsx(be,{className:u("w-4 h-4",a.is_active?"text-zinc-400":"text-zinc-500")}),e.jsx("span",{className:a.is_active?"text-zinc-600":"text-zinc-700 font-medium",children:"Inactive"})]})]})]})]})]})]}),$&&a.role_id&&e.jsxs(w,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-lg font-semibold text-zinc-800 flex items-center gap-2",children:[e.jsx(V,{className:"w-5 h-5 text-amber-500"}),"Custom Permissions"]}),e.jsxs(N,{type:"button",variant:"outline",size:"sm",onClick:()=>ie(!C),children:[C?"Hide":"Show"," Permissions"]})]}),e.jsxs("p",{className:"text-sm text-zinc-500 mb-4",children:["Override role permissions for this specific user.",e.jsx("span",{className:"text-blue-500",children:" Blue"})," = Custom granted,",e.jsx("span",{className:"text-red-500",children:" Red"})," = Revoked from role."]}),C&&e.jsx("div",{className:"space-y-6",children:O?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(E,{className:"w-6 h-6 text-amber-500 animate-spin"})}):Object.entries(B).map(([s,t])=>e.jsxs("div",{className:"border border-zinc-200 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium text-zinc-800 mb-3 capitalize",children:s.replace("_"," ")}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:Array.isArray(t)&&t.map(r=>{const n=K(r.id),i=oe(r.id);return e.jsxs("label",{className:u("flex items-center gap-3 p-2 rounded-lg cursor-pointer transition-all","hover:bg-zinc-50",n?"bg-emerald-50/50":""),children:[e.jsx("input",{type:"checkbox",checked:n,onChange:l=>le(r.id,l.target.checked),className:"w-4 h-4 text-amber-500 border-zinc-300 rounded focus:ring-amber-500"}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx("p",{className:"text-sm text-zinc-700 truncate",children:r.name})}),i.label&&e.jsx("span",{className:u("text-xs",i.color),children:i.label})]},r.id)})})]},s))})]})]}),e.jsx("div",{className:"space-y-6",children:e.jsxs(w,{className:"p-6 sticky top-24",children:[e.jsxs("h3",{className:"text-lg font-semibold text-zinc-800 mb-4 flex items-center gap-2",children:[e.jsx(V,{className:"w-5 h-5 text-amber-500"}),"Effective Permissions"]}),W?e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"text-sm text-zinc-500 mb-4",children:["Permissions for ",e.jsx("strong",{children:W.name}),(f.length>0||g.length>0)&&e.jsxs("span",{className:"text-amber-600",children:[" ","+ custom overrides"]}),":"]}),O?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(E,{className:"w-6 h-6 text-amber-500 animate-spin"})}):k.length>0?e.jsx("div",{className:"space-y-2 max-h-80 overflow-y-auto",children:k.map((s,t)=>e.jsxs(_e.div,{initial:{opacity:0,x:-10},animate:{opacity:1,x:0},transition:{delay:t*.03},className:"flex items-center gap-2 text-sm",children:[e.jsx(J,{className:"w-4 h-4 text-emerald-500 flex-shrink-0"}),e.jsx("span",{className:"text-zinc-600",children:s})]},s))}):e.jsx("p",{className:"text-sm text-zinc-400 italic",children:"No permissions assigned"}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-zinc-200 text-xs text-zinc-500 space-y-1",children:[e.jsxs("p",{children:["Total: ",k.length," permissions"]}),f.length>0&&e.jsxs("p",{className:"text-blue-500",children:["+",f.length," custom granted"]}),g.length>0&&e.jsxs("p",{className:"text-red-500",children:["-",g.length," revoked"]})]})]}):e.jsx("p",{className:"text-sm text-zinc-400 italic",children:"Select a role to view permissions"}),e.jsxs("div",{className:"mt-6 pt-6 border-t border-zinc-200 space-y-3",children:[e.jsx(N,{type:"submit",variant:"accent",fullWidth:!0,size:"lg",leftIcon:Ce,loading:Y,children:o?"Update User":"Create User"}),e.jsx(N,{type:"button",variant:"outline",fullWidth:!0,onClick:()=>p("/settings/users"),children:"Cancel"})]})]})})]})})})}export{Ve as default};
