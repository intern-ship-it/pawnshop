import{a as ue,u as pe,b as fe,r as a,M as ge,e as d,j as e,L as T,T as $,R as je,i as B,m as be,d as S,C as Ne,H as ve,J as we}from"./index-o28qtZ4E.js";import{r as W}from"./roleService-_PZHj77A.js";import{P as ye}from"./PageWrapper-D4uzFYGf.js";import{C as m,S as O,M as C,I as ze}from"./Modal-7Sg338uS.js";import{B as c,m as K}from"./proxy-D6mGC7EI.js";import{U as Se,a as Ce}from"./user-x-DQUafW5_.js";import{S as Q}from"./shield-check-BgGHvqnq.js";import{B as Pe}from"./building-2-xsKCLuU5.js";import{S as Re}from"./square-pen-DhoP9-Gi.js";import{K as V}from"./key-Cqdn2BOI.js";import{T as Ue}from"./trash-2-D5yhdYvO.js";import{P as De}from"./plus-CQNf_PUI.js";const q={"super-admin":{bg:"bg-purple-100",text:"text-purple-700",icon:"ðŸ‘‘"},admin:{bg:"bg-blue-100",text:"text-blue-700",icon:"âš™ï¸"},manager:{bg:"bg-amber-100",text:"text-amber-700",icon:"ðŸ“‹"},cashier:{bg:"bg-emerald-100",text:"text-emerald-700",icon:"ðŸ’°"},auditor:{bg:"bg-zinc-100",text:"text-zinc-700",icon:"ðŸ‘ï¸"}},G={active:{bg:"bg-emerald-100",text:"text-emerald-700",label:"Active"},inactive:{bg:"bg-zinc-100",text:"text-zinc-500",label:"Inactive"}};function Ke(){const P=ue(),n=pe(),{role:R}=fe(s=>s.auth);R?.slug;const[x,U]=a.useState([]),[j,H]=a.useState([]),[J,D]=a.useState(!0),[E,A]=a.useState(null),[b,X]=a.useState(""),[N,Y]=a.useState("all"),[v,Z]=a.useState("all"),[ee,p]=a.useState(!1),[se,f]=a.useState(!1),[te,w]=a.useState(!1),[r,h]=a.useState(null),[o,g]=a.useState(""),[ae,k]=a.useState(!1),[le,L]=a.useState(!1),[re,M]=a.useState({}),[ie,F]=a.useState(!1),y=a.useCallback(async()=>{D(!0),A(null);try{const s=await ge("/users");if(s.success)U(s.data||[]);else throw new Error(s.message||"Failed to fetch users");const t=await W.getRoles();t.success&&H(t.data||[])}catch(s){console.error("Error fetching data:",s),A(s.message||"Failed to load users"),n(d({id:Date.now(),type:"error",title:"Error",message:s.message||"Failed to load users"}))}finally{D(!1)}},[n]);a.useEffect(()=>{y()},[y]);const z={total:x.length,active:x.filter(s=>s.is_active).length,inactive:x.filter(s=>!s.is_active).length,byRole:j.reduce((s,t)=>(s[t.slug]=x.filter(l=>l.role?.slug===t.slug||l.role_id===t.id).length,s),{})},I=x.filter(s=>{const t=b.toLowerCase(),l=!b||s.name?.toLowerCase().includes(t)||s.username?.toLowerCase().includes(t)||s.email?.toLowerCase().includes(t)||s.employee_id?.toLowerCase().includes(t),i=s.role?.slug||"",u=N==="all"||i===N,he=s.is_active?"active":"inactive";return l&&u&&(v==="all"||he===v)}),ne=s=>s?new Date(s).toLocaleString("en-MY",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"}):"Never",ce=async()=>{if(r){k(!0);try{const s=await ve(`/users/${r.id}`);if(s.success)U(t=>t.filter(l=>l.id!==r.id)),n(d({id:Date.now(),type:"success",title:"User Deleted",message:`${r.name} has been removed`})),p(!1),h(null);else throw new Error(s.message||"Failed to delete user")}catch(s){n(d({id:Date.now(),type:"error",title:"Error",message:s.message||"Failed to delete user"}))}finally{k(!1)}}},oe=async()=>{if(!(!r||!o)){if(o.length<8){n(d({id:Date.now(),type:"error",title:"Error",message:"Password must be at least 8 characters"}));return}L(!0);try{const s=await we(`/users/${r.id}`,{password:o});if(s.success)n(d({id:Date.now(),type:"success",title:"Password Reset",message:`Password for ${r.name} has been updated`})),f(!1),h(null),g("");else throw new Error(s.message||"Failed to reset password")}catch(s){n(d({id:Date.now(),type:"error",title:"Error",message:s.message||"Failed to reset password"}))}finally{L(!1)}}},de=async s=>{h(s),w(!0),F(!0);try{if(s.role_id||s.role?.id){const t=await W.getRolePermissions(s.role_id||s.role?.id);t.success&&M(t.data||{})}}catch(t){console.error("Error fetching permissions:",t)}finally{F(!1)}},_=()=>{const s=[];return Object.entries(re).forEach(([t,l])=>{Array.isArray(l)&&l.forEach(i=>{i.is_enabled&&s.push({module:t,...i})})}),s},me=[{value:"all",label:"All Roles"},...j.map(s=>({value:s.slug,label:s.name}))],xe=s=>{const t=["bg-blue-500","bg-emerald-500","bg-amber-500","bg-purple-500","bg-pink-500","bg-indigo-500"],l=(s?.charCodeAt(0)||0)%t.length;return t[l]};return J?e.jsx("div",{className:"min-h-[60vh] flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(T,{className:"w-12 h-12 text-amber-500 animate-spin mx-auto mb-4"}),e.jsx("p",{className:"text-zinc-500",children:"Loading users..."})]})}):E?e.jsx("div",{className:"min-h-[60vh] flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx($,{className:"w-12 h-12 text-red-500 mx-auto mb-4"}),e.jsx("p",{className:"text-zinc-800 font-medium mb-2",children:"Failed to load users"}),e.jsx("p",{className:"text-zinc-500 mb-4",children:E}),e.jsx(c,{onClick:y,leftIcon:je,children:"Try Again"})]})}):e.jsxs(ye,{title:"User Management",subtitle:"Manage system users and access control",actions:e.jsx(c,{variant:"accent",leftIcon:De,onClick:()=>P("/settings/users/new"),children:"Add User"}),children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6",children:[e.jsx(m,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center",children:e.jsx(B,{className:"w-5 h-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-zinc-500",children:"Total Users"}),e.jsx("p",{className:"text-xl font-bold text-zinc-800",children:z.total})]})]})}),e.jsx(m,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-emerald-100 flex items-center justify-center",children:e.jsx(Se,{className:"w-5 h-5 text-emerald-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-zinc-500",children:"Active"}),e.jsx("p",{className:"text-xl font-bold text-emerald-600",children:z.active})]})]})}),e.jsx(m,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-amber-100 flex items-center justify-center",children:e.jsx(Q,{className:"w-5 h-5 text-amber-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-zinc-500",children:"Roles"}),e.jsx("p",{className:"text-xl font-bold text-amber-600",children:j.length})]})]})}),e.jsx(m,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-red-100 flex items-center justify-center",children:e.jsx(Ce,{className:"w-5 h-5 text-red-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-zinc-500",children:"Inactive"}),e.jsx("p",{className:"text-xl font-bold text-red-500",children:z.inactive})]})]})})]}),e.jsx(m,{className:"p-4 mb-6",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(be,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-400"}),e.jsx("input",{type:"text",placeholder:"Search by name, username or email...",value:b,onChange:s=>X(s.target.value),className:"w-full pl-10 pr-4 py-2 border border-zinc-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-amber-500/20 focus:border-amber-500"})]})}),e.jsx(O,{value:N,onChange:s=>Y(s.target.value),options:me,className:"w-40"}),e.jsx(O,{value:v,onChange:s=>Z(s.target.value),options:[{value:"all",label:"All Status"},{value:"active",label:"Active"},{value:"inactive",label:"Inactive"}],className:"w-40"})]})}),e.jsx(m,{className:"overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-zinc-50 border-b border-zinc-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-4 text-left text-xs font-semibold text-zinc-500 uppercase",children:"User"}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-semibold text-zinc-500 uppercase",children:"Role"}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-semibold text-zinc-500 uppercase",children:"Branch"}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-semibold text-zinc-500 uppercase",children:"Last Login"}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-semibold text-zinc-500 uppercase",children:"Status"}),e.jsx("th",{className:"px-6 py-4 text-right text-xs font-semibold text-zinc-500 uppercase",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-zinc-100",children:I.length===0?e.jsx("tr",{children:e.jsxs("td",{colSpan:6,className:"px-6 py-12 text-center",children:[e.jsx(B,{className:"w-12 h-12 text-zinc-300 mx-auto mb-3"}),e.jsx("p",{className:"text-zinc-500",children:"No users found"})]})}):I.map((s,t)=>{const l=s.role?.slug||"cashier",i=q[l]||q.cashier,u=s.is_active?G.active:G.inactive;return e.jsxs(K.tr,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:t*.03},className:"hover:bg-zinc-50 transition-colors",children:[e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:S("w-10 h-10 rounded-full flex items-center justify-center text-white font-semibold",xe(s.name)),children:s.name?.charAt(0)||"U"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-zinc-800",children:s.name}),e.jsxs("p",{className:"text-sm text-zinc-500",children:["@",s.username]})]})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("span",{className:S("inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium",i.bg,i.text),children:[e.jsx("span",{children:i.icon}),s.role?.name||"Unknown"]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-zinc-600",children:[e.jsx(Pe,{className:"w-4 h-4 text-zinc-400"}),s.branch?.name||"No Branch"]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-zinc-600",children:[e.jsx(Ne,{className:"w-4 h-4 text-zinc-400"}),ne(s.last_login_at)]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("span",{className:S("inline-flex px-2.5 py-1 rounded-full text-xs font-medium",u.bg,u.text),children:u.label})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{onClick:()=>P(`/settings/users/${s.id}/edit`),className:"p-2 text-zinc-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors",title:"Edit User",children:e.jsx(Re,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>{h(s),f(!0)},className:"p-2 text-zinc-400 hover:text-amber-600 hover:bg-amber-50 rounded-lg transition-colors",title:"Reset Password",children:e.jsx(V,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>de(s),className:"p-2 text-zinc-400 hover:text-purple-600 hover:bg-purple-50 rounded-lg transition-colors",title:"View Permissions",children:e.jsx(Q,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>{h(s),p(!0)},className:"p-2 text-zinc-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors",title:"Delete User",children:e.jsx(Ue,{className:"w-4 h-4"})})]})})]},s.id)})})]})})}),e.jsx(C,{isOpen:ee,onClose:()=>p(!1),title:"Delete User",size:"sm",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-red-100 flex items-center justify-center",children:e.jsx($,{className:"w-6 h-6 text-red-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-zinc-800 font-medium",children:"Are you sure?"}),e.jsxs("p",{className:"text-sm text-zinc-500",children:["This will permanently delete"," ",e.jsx("strong",{children:r?.name})]})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(c,{variant:"outline",fullWidth:!0,onClick:()=>p(!1),children:"Cancel"}),e.jsx(c,{variant:"danger",fullWidth:!0,onClick:ce,loading:ae,children:"Delete"})]})]})}),e.jsx(C,{isOpen:se,onClose:()=>{f(!1),g("")},title:"Reset Password",size:"sm",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("p",{className:"text-sm text-zinc-500 mb-4",children:["Enter a new password for ",e.jsx("strong",{children:r?.name})]}),e.jsx(ze,{label:"New Password",type:"password",value:o,onChange:s=>g(s.target.value),placeholder:"Minimum 8 characters",leftIcon:V}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx(c,{variant:"outline",fullWidth:!0,onClick:()=>{f(!1),g("")},children:"Cancel"}),e.jsx(c,{variant:"accent",fullWidth:!0,onClick:oe,loading:le,disabled:!o||o.length<8,children:"Reset Password"})]})]})}),e.jsx(C,{isOpen:te,onClose:()=>{w(!1),M({})},title:`Permissions - ${r?.name}`,size:"md",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("p",{className:"text-sm text-zinc-500 mb-4",children:["Role: ",e.jsx("strong",{children:r?.role?.name})]}),ie?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(T,{className:"w-6 h-6 text-amber-500 animate-spin"})}):e.jsxs("div",{className:"max-h-80 overflow-y-auto space-y-2",children:[_().map((s,t)=>e.jsxs(K.div,{initial:{opacity:0,x:-10},animate:{opacity:1,x:0},transition:{delay:t*.02},className:"flex items-center gap-2 text-sm py-1",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-emerald-500"}),e.jsx("span",{className:"text-zinc-600",children:s.name})]},`${s.module}-${s.action}`)),_().length===0&&e.jsx("p",{className:"text-zinc-400 text-center py-4",children:"No permissions assigned"})]}),e.jsx("div",{className:"mt-6 pt-4 border-t border-zinc-200",children:e.jsx(c,{variant:"outline",fullWidth:!0,onClick:()=>w(!1),children:"Close"})})]})})]})}export{Ke as default};
